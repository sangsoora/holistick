<div class="container services-page">
  <%= simple_form_for :search, url: services_path, method: "GET", html: { id: 'filter-form' } do |f| %>
    <div class="d-flex justify-content-between">
      <fieldset class="form-group check_boxes required search_specialty <%= "hidden" if params[:search] && params[:search][:health_goal] != [""] %>" id="specialty-selector" style="position: relative; width: 30%;">
        <legend class="btn btn-ghost" id="specialty-pop">Specialties <% if params[:search] && params[:search][:specialty] %>(<%= params[:search][:specialty].reject(&:blank?).count %>)<% end %></legend>
        <div class="specialty-select-box" id="specialty-select-box">
          <div class="specialty-choices">
            <% Specialty.all.sort_by(&:name).each do |specialty| %>
              <% if params[:search] && params[:search][:specialty] %>
                <% if params[:search][:specialty].include?((specialty.id).to_s) %>
                  <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= specialty.id %>" name="search[specialty][]" id="search_specialty_<%= specialty.id %>" checked><label class="form-check-label collection_check_boxes specialty-choice active" for="search_specialty_<%= specialty.id %>"><%= specialty.name %></label>
                <% else %>
                  <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= specialty.id %>" name="search[specialty][]" id="search_specialty_<%= specialty.id %>"><label class="form-check-label collection_check_boxes specialty-choice" for="search_specialty_<%= specialty.id %>"><%= specialty.name %></label>
                <% end %>
              <% else %>
                <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= specialty.id %>" name="search[specialty][]" id="search_specialty_<%= specialty.id %>"><label class="form-check-label collection_check_boxes specialty-choice" for="search_specialty_<%= specialty.id %>"><%= specialty.name %></label>
              <% end %>
            <% end %>
          </div>
        </div>
        <input type="hidden" name="search[specialty][]" value="">
        <div id="selected-specialties">
          <%# if params[:search] && params[:search][:specialty] && params[:search][:specialty] != [""] %>
            <%# params[:search][:specialty].reject(&:blank?).each do |search_id| %>
              <!-- <p id="specialty-<%#= search_id %>"><%#= Specialty.find(search_id).name %></p> -->
            <%# end %>
          <%# end %>
        </div>
      </fieldset>
      <fieldset class="form-group check_boxes required search_health_goal <%= "hidden" if params[:search] && params[:search][:specialty] != [""] %>" id="health-goal-selector" style="position: relative; width: 30%;">
        <legend class="btn btn-ghost" id="health-goal-pop">Health Goals <% if params[:search] && params[:search][:health_goal] %>(<%= params[:search][:health_goal].reject(&:blank?).count %>)<% end %></legend>
        <div class="health-goal-select-box" id="health-goal-select-box">
          <div class="health-goal-choices">
            <% HealthGoal.all.sort_by(&:name).each do |goal| %>
              <% if params[:search] && params[:search][:health_goal] %>
                <% if params[:search][:health_goal].include?((goal.id).to_s) %>
                  <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= goal.id %>" name="search[health_goal][]" id="search_health_goal_<%= goal.id %>" checked><label class="form-check-label collection_check_boxes health-goal-choice active" for="search_health_goal_<%= goal.id %>"><%= goal.name %></label>
                <% else %>
                  <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= goal.id %>" name="search[health_goal][]" id="search_health_goal_<%= goal.id %>"><label class="form-check-label collection_check_boxes health-goal-choice" for="search_health_goal_<%= goal.id %>"><%= goal.name %></label>
                <% end %>
              <% else %>
                <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= goal.id %>" name="search[health_goal][]" id="search_health_goal_<%= goal.id %>"><label class="form-check-label collection_check_boxes health-goal-choice" for="search_health_goal_<%= goal.id %>"><%= goal.name %></label>
              <% end %>
            <% end %>
          </div>
        </div>
        <input type="hidden" name="search[health_goal][]" value="">
        <div id="selected-health-goals"></div>
      </fieldset>
      <fieldset class="form-group check_boxes required search_language" style="position: relative; width: 20%;">
        <legend class="btn btn-ghost" id="language-pop">Language <% if params[:search] && params[:search][:language] %>(<%= params[:search][:language].reject(&:blank?).count %>)<% end %></legend>
        <div class="language-select-box" id="language-select-box">
          <div class="language-choices">
            <% Language.includes(:practitioner_languages).where.not(practitioner_languages: { id: nil }).sort_by(&:name).each do |language| %>
              <% if params[:search] && params[:search][:language] && params[:search][:language].include?((language.id).to_s) %>
                <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= language.id %>" name="search[language][]" id="search_language_<%= language.id %>" checked><label class="form-check-label collection_check_boxes language-choice active" for="search_language_<%= language.id %>"><%= language.name %></label>
              <% else %>
                <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= language.id %>" name="search[language][]" id="search_language_<%= language.id %>"><label class="form-check-label collection_check_boxes language-choice" for="search_language_<%= language.id %>"><%= language.name %></label>
              <% end %>
            <% end %>
          </div>
        </div>
        <input type="hidden" name="search[language][]" value="">
        <div id="selected-languages"></div>
      </fieldset>
      <div class="form-group select required search_service_type"><label class="btn btn-ghost" style="cursor: default;" for="search_service_type">Service type</label><select class="form-control select required" name="search[service_type]" id="search_service_type">
        <option value="">Both</option>
        <option value="Virtual" <%= 'selected' if params[:search] && params[:search][:service_type] == "Virtual" %>>Virtual</option>
        <option value="In-person" <%= 'selected' if params[:search] && params[:search][:service_type] == "In-person" %>>In-person</option></select>
      </div>
    </div>
    <%= f.submit "Search", class: "btn btn-flat" %>
    <%= link_to "Reset", services_path, class: 'btn btn-ghost ml-5'  %>
  <% end %>
  <div>
    <% if @filtered_services %>
      <% if @filtered_services != [] %>
        <div class="sort-btns">
          <div class="btn btn-ghost pink w-100 active-sort" id="sortPrice">Lower Price</div>
          <div class="btn btn-ghost pink w-100" id="sortDuration">Shorter Duration</div>
        </div>
        <div class="service-lists">
          <% @filtered_services.each do |service| %>
            <div class="service-list-item" data-price="<%= service.price.to_i %>" data-duration="<%= service.duration %>">
              <div class="service-list-item-title">
                <h3><%= link_to service.name, service_path(service) %></h3>
              </div>
              <div class="service-list-item-infos">
                <div class="service-list-item-practitioner">
                  <a href="/practitioners/<%= service.practitioner.id %>">
                    <% if service.practitioner.photo.attached? %>
                      <%= cl_image_tag practitioner.photo.key, class: 'service-list-item-user avatar-bordered' %>
                    <% else %>
                      <img src='https://kitt.lewagon.com/placeholder/users/random' class="service-list-item-user avatar-bordered"/>
                    <% end %>
                    <p><%= service.practitioner.user.full_name %></p>
                  </a>
                </div>
                <div class="service-list-item-details">
                  <p><%= service.service_type.capitalize %></p>
                  <p><%= service.duration %>m</p>
                  <p>CA$ <%= service.price.to_f.round(2) %></p>
                  <% service.languages.each do |language| %>
                    <p><%= language.name %></p>
                  <% end %>
                </div>
              </div>
              <div class="d-flex justify-content-center">
                <a class="btn btn-flat" href="/services/<%= service.id %>">Book now</a>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p>Please try differnent filters for search!</p>
      <% end %>
    <% else %>
      <div class="specialty-list">
        <div class="specialty-items btn btn-ghost pink active-specialty w-100"><%= Specialty.all.sort_by(&:name).first.name %></div>
        <% Specialty.all.sort_by(&:name).drop(1).each do |specialty| %>
          <div class="specialty-items btn btn-ghost pink w-100"><%= specialty.name %></div>
        <% end %>
      </div>
      <% @services.each do |specialty, services| %>
        <% if specialty == Specialty.all.sort_by(&:name).first %>
          <div class="service-lists">
        <% else %>
          <div class="service-lists" style="display: none;">
        <% end %>
          <% services.each do |service| %>
            <div class="service-list-item">
              <div class="service-list-item-title">
                <h3><%= link_to service.name, service_path(service) %></h3>
              </div>
              <div class="service-list-item-infos">
                <div class="service-list-item-practitioner">
                  <a href="/practitioners/<%= service.practitioner.id %>">
                    <% if service.practitioner.photo.attached? %>
                      <%= cl_image_tag practitioner.photo.key, class: 'service-list-item-user avatar-bordered' %>
                    <% else %>
                      <img src='https://kitt.lewagon.com/placeholder/users/random' class="service-list-item-user avatar-bordered"/>
                    <% end %>
                    <p><%= service.practitioner.user.full_name %></p>
                  </a>
                </div>
                <div class="service-list-item-details">
                  <p><%= service.service_type.capitalize %></p>
                  <p><%= service.duration %>m</p>
                  <p>CA$ <%= service.price.to_f.round(2) %></p>
                  <% service.languages.each do |language| %>
                    <p><%= language.name %></p>
                  <% end %>
                </div>
              </div>
              <div class="d-flex justify-content-center">
                <a class="btn btn-flat" href="/services/<%= service.id %>">Book now</a>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
</div>
<script>
  const specialtySelectBoxBtn = document.getElementById('specialty-pop');
  specialtySelectBoxBtn.addEventListener('click', () => {
    specialtySelectBoxBtn.classList.toggle('btn-opened');
    healthGoalSelectBoxBtn.classList.remove('btn-opened');
    languageSelectBoxBtn.classList.remove('btn-opened');
    document.getElementById('specialty-select-box').classList.toggle('opened');
    document.getElementById('health-goal-select-box').classList.remove('opened');
    document.getElementById('language-select-box').classList.remove('opened');
  });
  const healthGoalSelectBoxBtn = document.getElementById('health-goal-pop');
  healthGoalSelectBoxBtn.addEventListener('click', () => {
    healthGoalSelectBoxBtn.classList.toggle('btn-opened');
    specialtySelectBoxBtn.classList.remove('btn-opened');
    languageSelectBoxBtn.classList.remove('btn-opened');
    document.getElementById('health-goal-select-box').classList.toggle('opened');
    document.getElementById('specialty-select-box').classList.remove('opened');
    document.getElementById('language-select-box').classList.remove('opened');
  });
  const languageSelectBoxBtn = document.getElementById('language-pop');
  languageSelectBoxBtn.addEventListener('click', () => {
    languageSelectBoxBtn.classList.toggle('btn-opened');
    specialtySelectBoxBtn.classList.remove('btn-opened');
    healthGoalSelectBoxBtn.classList.remove('btn-opened');
    document.getElementById('language-select-box').classList.toggle('opened');
    document.getElementById('specialty-select-box').classList.remove('opened');
    document.getElementById('health-goal-select-box').classList.remove('opened');
  });
  const tabs = document.querySelectorAll('.specialty-items')
  const lists = document.querySelectorAll('.service-lists')
  const entries = function*(iterable) {
    let i = 0;
    for (item of iterable) {
      yield [i++, item]
    }
  }
  const showBlock = index => {
    for (const [blockIndex, block] of entries(lists)) {
      block.style.display = blockIndex === index ? 'grid' : 'none'
    }
  }
  showBlock(0)
  for (const [tabIndex, tab] of entries(tabs)) {
    tab.addEventListener('click', e => {
      e.preventDefault();
      showBlock(tabIndex);
      const activeTab = document.querySelector('.active-specialty');
      event.currentTarget.classList.toggle('active-specialty');
      if (activeTab !== null) {
        activeTab.classList.remove('active-specialty');
      }
    })
  }
  const priceBtn = document.getElementById('sortPrice');
  const durationBtn = document.getElementById('sortDuration');
  priceBtn.addEventListener('click', (event) =>{
    const active = document.querySelector('.active-sort');
    active.classList.remove('active-sort');
    event.currentTarget.classList.add('active-sort');
    var $wrapper = $('.service-lists');
    $wrapper.find('.service-list-item').sort(function(a, b) {
        return +a.dataset.price - +b.dataset.price;
    })
    .appendTo($wrapper);
  })
  durationBtn.addEventListener('click', (event) =>{
    const active = document.querySelector('.active-sort');
    active.classList.remove('active-sort');
    event.currentTarget.classList.add('active-sort');
    var $wrapper = $('.service-lists');
    $wrapper.find('.service-list-item').sort(function(a, b) {
        return +a.dataset.duration - +b.dataset.duration;
    })
    .appendTo($wrapper);
  })
</script>
