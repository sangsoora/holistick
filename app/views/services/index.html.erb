<div class="filter-bar">
  <%= simple_form_for :search, url: services_path, method: "GET", html: { id: 'filter-form' } do |f| %>
    <div class="d-flex align-items-center">
      <fieldset class="form-group mr-4 check_boxes required search_health_goal <%= "hidden" if params[:search] && params[:search][:specialty] && params[:search][:specialty] != [""] %>" id="health-goal-selector">
        <legend class="btn btn-ghost" id="health-goal-pop">Health Goals <% if params[:search] && params[:search][:health_goal] && params[:search][:health_goal].length > 1 %>(<%= params[:search][:health_goal].reject(&:blank?).count %>)<% end %></legend>
        <div class="health-goal-select-box" id="health-goal-select-box">
          <div class="health-goal-choices">
            <% HealthGoal.all.sort_by(&:name).each do |goal| %>
              <% if params[:search] && params[:search][:health_goal] %>
                <% if params[:search][:health_goal].include?((goal.id).to_s) %>
                  <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= goal.id %>" name="search[health_goal][]" id="search_health_goal_<%= goal.id %>" checked><label class="form-check-label collection_check_boxes health-goal-choice active" for="search_health_goal_<%= goal.id %>"><%= goal.name %></label>
                <% else %>
                  <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= goal.id %>" name="search[health_goal][]" id="search_health_goal_<%= goal.id %>"><label class="form-check-label collection_check_boxes health-goal-choice" for="search_health_goal_<%= goal.id %>"><%= goal.name %></label>
                <% end %>
              <% else %>
                <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%= goal.id %>" name="search[health_goal][]" id="search_health_goal_<%= goal.id %>"><label class="form-check-label collection_check_boxes health-goal-choice" for="search_health_goal_<%= goal.id %>"><%= goal.name %></label>
              <% end %>
            <% end %>
          </div>
        </div>
        <input type="hidden" name="search[health_goal][]" value="">
      </fieldset>
      <!-- <fieldset class="form-group mr-4 check_boxes required search_language">
        <legend class="btn btn-ghost" id="language-pop">Language <% if params[:search] && params[:search][:language] && params[:search][:language].length > 1 %>(<%= params[:search][:language].reject(&:blank?).count %>)<% end %></legend>
        <div class="language-select-box" id="language-select-box">
          <div class="language-choices">
            <%# Language.includes(:practitioner_languages).where.not(practitioner_languages: { id: nil }).sort_by(&:name).each do |language| %>
              <%# if params[:search] && params[:search][:language] && params[:search][:language].include?((language.id).to_s) %>
                <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%#= language.id %>" name="search[language][]" id="search_language_<%#= language.id %>" checked><label class="form-check-label collection_check_boxes language-choice active" for="search_language_<%#= language.id %>"><%#= language.name %></label>
              <%# else %>
                <input class="form-check-input check_boxes required hidden" type="checkbox" value="<%#= language.id %>" name="search[language][]" id="search_language_<%#= language.id %>"><label class="form-check-label collection_check_boxes language-choice" for="search_language_<%#= language.id %>"><%#= language.name %></label>
              <%# end %>
            <%# end %>
          </div>
        </div>
        <input type="hidden" name="search[language][]" value="">
      </fieldset>
      <div class="form-group select mr-4 required search_service_type">
        <label class="btn btn-ghost" id="service-type-pop" style="cursor: default;" for="search_service_type">Service type</label>
        <div class="service-type-select-box" id="service-type-select-box">
          <select class="form-control select required" name="search[service_type]" id="search_service_type">
            <option value="">Both</option>
            <option value="Virtual" <%#= 'selected' if params[:search] && params[:search][:service_type] == "Virtual" %>>Virtual</option>
            <option value="In-person" <%#= 'selected' if params[:search] && params[:search][:service_type] == "In-person" %>>In-person</option>
          </select>
        </div>
      </div> -->
      <%= f.submit "Apply", class: "btn btn-flat" %>
      <%= link_to "Reset", services_path, class: 'btn btn-ghost ml-5' %>
    </div>
  <% end %>
  <div class="search-box-wrapper">
    <i class="fas fa-search"></i><input id="search-box" placeholder="Search by practitioner name or specialty">
    <div id="text-select-box">
      <div id="text-choices">
        <div id="practitioner-choices">
          <h4>By Practitioners</h4>
          <div id="practitioner-choices-list"></div>
        </div>
        <div id="specialty-choices">
          <h4>By Specialties</h4>
          <div id="specialty-choices-list"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="container services-page">
  <div>
    <div class="sort-btns">
      <div class="btn btn-ghost pink mr-4 mb-3 active-sort" id="sortPrice">Lower Price</div>
      <div class="btn btn-ghost pink mr-4 mb-3" id="sortDuration">Shorter Duration</div>
    </div>
    <% if @filtered_services %>
      <% if @filtered_services != [] %>
        <div class="service-lists">
          <% @filtered_services.each do |service| %>
            <div class="service-list-item" data-price="<%= service.price.to_i %>" data-duration="<%= service.duration %>">
              <div class="service-left-column">
                <div class="service-list-item-title">
                  <h3><%= link_to service.name, service_path(service) %></h3>
                  <div class="fav-btn" id="fav-btn-<%= service.id %>">
                    <% if user_signed_in? %>
                      <%= render 'favorite_services/service_btn', service: service %>
                    <% end %>
                  </div>
                </div>
                <div class="service-list-item-details">
                  <div class="service-list-item-detail-left">
                    <% if service.reviews.count > 0 %>
                      <p><i class="fas fa-star mr-2 pink-icon"></i><%= service.rating_avg %> (<%= service.reviews.count %>)</p>
                    <% else %>
                      <p>No reviews!</p>
                    <% end %>
                    <a class="btn btn-flat" href="/services/<%= service.id %>">Book</a>
                  </div>
                  <div class="service-list-item-detail-middle">
                    <label>TYPE</label>
                    <p><%= service.service_type.capitalize %></p>
                    <label>PRICE</label>
                    <p>CA$ <%= service.price.to_f.round(2) %></p>
                  </div>
                  <div class="service-list-item-detail-right">
                    <label>LANGUAGES</label>
                    <p>
                      <% if service.languages.length <= 2 %>
                        <%= service.languages.pluck(:name).join(', ') %>
                      <% elsif service.languages.length > 2 %>
                        <%= service.languages.first(2).pluck(:name).join(', ') %>, + <%= service.languages.length - 2 %>
                      <% end %>

                    </p>
                    <label>DURATION</label>
                    <p><%= service.duration %> mins</p>
                  </div>
                </div>
              </div>
              <div class="service-right-column">
                <ul class="list-inline tabs-underlined">
                  <li>
                    <p class="tab-underlined active-tab" id="tab-practitioner-<%= service.id %>">Practitioner</p>
                  </li>
                  <li>
                    <p class="tab-underlined" id="tab-service-<%= service.id %>">Service Info</p>
                  </li>
                </ul>
                <div class="lists" id="practitioner-<%= service.id %>">
                  <div class="service-list-item-practitioner">
                    <div class="profile-photo">
                      <a href="/practitioners/<%= service.practitioner.id %>">
                        <% if service.practitioner.photo.attached? %>
                          <%= cl_image_tag service.practitioner.photo.key, class: 'service-list-item-user avatar-bordered' %>
                        <% else %>
                          <img src='https://kitt.lewagon.com/placeholder/users/random' class="service-list-item-user avatar-bordered"/>
                        <% end %>
                      </a>
                      <p><%= service.practitioner.location %></p>
                    </div>
                    <div class="general-info">
                      <h4><%= service.practitioner.user.full_name %></h4>
                      <p><%= service.practitioner.specialties.pluck(:name).join(', ') %></p>
                    </div>
                  </div>
                </div>
                <div class="lists hidden" id="service-<%= service.id %>">
                  <div class="service-list-item-infos">
                    <p <%= 'class=short' if service.description.length >= 250 %> ><%= service.description %></p>
                    <% if service.description.length >= 250 %>
                      <%= link_to 'Read more', service_path(service) %>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
            <script>
              document.getElementById("tab-practitioner-<%= service.id %>").addEventListener('click', (e) => {
                e.target.classList.add('active-tab');
                document.getElementById("tab-service-<%= service.id %>").classList.remove('active-tab');
                document.getElementById("practitioner-<%= service.id %>").classList.remove('hidden');
                document.getElementById("service-<%= service.id %>").classList.add('hidden');
              })
              document.getElementById("tab-service-<%= service.id %>").addEventListener('click', (e) => {
                e.target.classList.add('active-tab');
                document.getElementById("tab-practitioner-<%= service.id %>").classList.remove('active-tab');
                document.getElementById("service-<%= service.id %>").classList.remove('hidden');
                document.getElementById("practitioner-<%= service.id %>").classList.add('hidden');
              })
            </script>
          <% end %>
        </div>
      <% else %>
        <p>Please try different filters for search!</p>
      <% end %>
    <% else %>
      <div class="service-lists">
        <% Service.all.each do |service| %>
          <div class="service-list-item" data-price="<%= service.price.to_i %>" data-duration="<%= service.duration %>">
            <div class="service-left-column">
              <div class="service-list-item-title">
                <h3><%= link_to service.name, service_path(service) %></h3>
                <div class="fav-btn" id="fav-btn-<%= service.id %>">
                  <% if user_signed_in? %>
                    <%= render 'favorite_services/service_btn', service: service %>
                  <% end %>
                </div>
              </div>
              <div class="service-list-item-details">
                <div class="service-list-item-detail-left">
                  <% if service.reviews.count > 0 %>
                    <p><i class="fas fa-star mr-2 pink-icon"></i><%= service.rating_avg %> (<%= service.reviews.count %>)</p>
                  <% else %>
                    <p>No reviews!</p>
                  <% end %>
                  <a class="btn btn-flat" href="/services/<%= service.id %>">Book</a>
                </div>
                <div class="service-list-item-detail-middle">
                  <label>TYPE</label>
                  <p><%= service.service_type.capitalize %></p>
                  <label>PRICE</label>
                  <p>CA$ <%= service.price.to_f.round(2) %></p>
                </div>
                <div class="service-list-item-detail-right">
                  <label>LANGUAGES</label>
                  <p>
                    <% if service.languages.length <= 2 %>
                      <%= service.languages.pluck(:name).join(', ') %>
                    <% elsif service.languages.length > 2 %>
                      <%= service.languages.first(2).pluck(:name).join(', ') %>, + <%= service.languages.length - 2 %>
                    <% end %>

                  </p>
                  <label>DURATION</label>
                  <p><%= service.duration %> mins</p>
                </div>
              </div>
            </div>
            <div class="service-right-column">
              <ul class="list-inline tabs-underlined">
                <li>
                  <p class="tab-underlined active-tab" id="tab-practitioner-<%= service.id %>">Practitioner</p>
                </li>
                <li>
                  <p class="tab-underlined" id="tab-service-<%= service.id %>">Service Info</p>
                </li>
              </ul>
              <div class="lists" id="practitioner-<%= service.id %>">
                <div class="service-list-item-practitioner">
                  <div class="profile-photo">
                    <a href="/practitioners/<%= service.practitioner.id %>">
                      <% if service.practitioner.photo.attached? %>
                        <%= cl_image_tag service.practitioner.photo.key, class: 'service-list-item-user avatar-bordered' %>
                      <% else %>
                        <img src='https://kitt.lewagon.com/placeholder/users/random' class="service-list-item-user avatar-bordered"/>
                      <% end %>
                    </a>
                    <p><%= service.practitioner.location %></p>
                  </div>
                  <div class="general-info">
                    <h4><%= service.practitioner.user.full_name %></h4>
                    <p><%= service.practitioner.specialties.pluck(:name).join(', ') %></p>
                  </div>
                </div>
              </div>
              <div class="lists hidden" id="service-<%= service.id %>">
                <div class="service-list-item-infos">
                  <p <%= 'class=short' if service.description.length >= 250 %> ><%= service.description %></p>
                  <% if service.description.length >= 250 %>
                    <%= link_to 'Read more', service_path(service) %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
          <script>
            document.getElementById("tab-practitioner-<%= service.id %>").addEventListener('click', (e) => {
              e.target.classList.add('active-tab');
              document.getElementById("tab-service-<%= service.id %>").classList.remove('active-tab');
              document.getElementById("practitioner-<%= service.id %>").classList.remove('hidden');
              document.getElementById("service-<%= service.id %>").classList.add('hidden');
            })
            document.getElementById("tab-service-<%= service.id %>").addEventListener('click', (e) => {
              e.target.classList.add('active-tab');
              document.getElementById("tab-practitioner-<%= service.id %>").classList.remove('active-tab');
              document.getElementById("service-<%= service.id %>").classList.remove('hidden');
              document.getElementById("practitioner-<%= service.id %>").classList.add('hidden');
            })
          </script>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
</div>
<script>
  const healthGoalSelectBoxBtn = document.getElementById('health-goal-pop');
  // const languageSelectBoxBtn = document.getElementById('language-pop');
  // const serviceTypeSelectBoxBtn = document.getElementById('service-type-pop');
  const healthGoalSelectBox = document.getElementById('health-goal-select-box');
  // const languageSelectBox = document.getElementById('language-select-box');
  // const serviceTypeSelectBox = document.getElementById('service-type-select-box');
  healthGoalSelectBoxBtn.addEventListener('click', () => {
    healthGoalSelectBoxBtn.classList.toggle('btn-opened');
    // languageSelectBoxBtn.classList.remove('btn-opened');
    // serviceTypeSelectBoxBtn.classList.remove('btn-opened');
    healthGoalSelectBox.classList.toggle('opened');
    // languageSelectBox.classList.remove('opened');
    // serviceTypeSelectBox.classList.remove('opened');
  });
  // languageSelectBoxBtn.addEventListener('click', () => {
  //   languageSelectBoxBtn.classList.toggle('btn-opened');
  //   healthGoalSelectBoxBtn.classList.remove('btn-opened');
  //   serviceTypeSelectBoxBtn.classList.remove('btn-opened');
  //   languageSelectBox.classList.toggle('opened');
  //   healthGoalSelectBox.classList.remove('opened');
  //   serviceTypeSelectBox.classList.remove('opened');
  // });
  // serviceTypeSelectBoxBtn.addEventListener('click', () => {
  //   serviceTypeSelectBoxBtn.classList.toggle('btn-opened');
  //   languageSelectBoxBtn.classList.remove('btn-opened');
  //   healthGoalSelectBoxBtn.classList.remove('btn-opened');
  //   serviceTypeSelectBox.classList.toggle('opened');
  //   healthGoalSelectBox.classList.remove('opened');
  //   languageSelectBox.classList.remove('opened');
  // });
  document.addEventListener('click', function(event) {
    const healthGoalBoxClick = healthGoalSelectBox.contains(event.target);
    const healthGoalBtnClick = healthGoalSelectBoxBtn.contains(event.target);
    // const languageBoxClick = languageSelectBox.contains(event.target);
    // const languageBtnClick = languageSelectBoxBtn.contains(event.target);
    // const serviceTypeBoxClick = serviceTypeSelectBox.contains(event.target);
    // const serviceTypeBtnClick = serviceTypeSelectBoxBtn.contains(event.target);
    if (healthGoalSelectBox.classList.contains('opened') && (!healthGoalBoxClick) && (!healthGoalBtnClick)) {
      healthGoalSelectBoxBtn.classList.remove('btn-opened');
      healthGoalSelectBox.classList.remove('opened');
    }
    //  else if (languageSelectBox.classList.contains('opened') && (!languageBoxClick) && (!languageBtnClick)) {
    //   languageSelectBoxBtn.classList.remove('btn-opened');
    //   languageSelectBox.classList.remove('opened');
    // } else if (serviceTypeSelectBox.classList.contains('opened') && (!serviceTypeBoxClick) && (!serviceTypeBtnClick)) {
    //   serviceTypeSelectBoxBtn.classList.remove('btn-opened');
    //   serviceTypeSelectBox.classList.remove('opened');
    // }
  })
  const priceBtn = document.getElementById('sortPrice');
  const durationBtn = document.getElementById('sortDuration');
  if (priceBtn) {
    priceBtn.addEventListener('click', (event) =>{
      const active = document.querySelector('.active-sort');
      active.classList.remove('active-sort');
      event.currentTarget.classList.add('active-sort');
      var $wrapper = $('.service-lists');
      $wrapper.find('.service-list-item').sort(function(a, b) {
        return +a.dataset.price - +b.dataset.price;
      })
      .appendTo($wrapper);
    })
  }
  if (durationBtn) {
    durationBtn.addEventListener('click', (event) =>{
      const active = document.querySelector('.active-sort');
      active.classList.remove('active-sort');
      event.currentTarget.classList.add('active-sort');
      var $wrapper = $('.service-lists');
      $wrapper.find('.service-list-item').sort(function(a, b) {
        return +a.dataset.duration - +b.dataset.duration;
      })
      .appendTo($wrapper);
    })
  }
  const textSearch = document.getElementById('search-box');
  const resultBox = document.getElementById('text-select-box');
  textSearch.addEventListener('keyup', (e) => {
    if (textSearch.value.length >= 2) {
      document.getElementById('practitioner-choices-list').innerHTML = '';
      resultBox.classList.add('opened');
      getPractitionersByName(textSearch.value);
      getSpecialtiesByName(textSearch.value);
    } else {
      resultBox.classList.remove('opened');
    }
  })
  const getPractitionersByName = (string) => {
    $.ajax({
      url: 'practitioners/filter',
      data: {query: string},
      success: function(data){
      }
    });
               // document.getElementById('practitioner-choices').insertAdjacentHTML('beforeend', html);
  }
  const getSpecialtiesByName = (string) => {
    $.ajax({
      url: 'specialties/filter',
      data: {query: string},
      success: function(data){
      }
    });
  }
</script>
