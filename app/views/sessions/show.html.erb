<% provide :head_tags do %>
  <% if @session.service.service_type == 'In-person' %>
    <meta name='turbolinks-visit-control' content='reload'>
    <script>
      document.addEventListener("DOMContentLoaded", function(){
        initMap(<%=@session.practitioner.latitude%>, <%=@session.practitioner.longitude%>, 'session-map')
      });
    </script>
  <% end %>
<% end %>
<div class="container session-page">
  <% if @session.practitioner.user == current_user %>
    <h2><%= @session.service.name %> with <%= @session.user.full_name %></h2>
    <% if @session.status == 'pending' && @session.paid %>
      <p class="mt-3"><%= @session.user.first_name %> has chose 3 time slots for the requested session. Please choose one to confirm the session.</p>
      <%= simple_form_for @session do |f| %>
        <div class="form-group">
          <input type="hidden" name="session[time]" value="primary">
          <div class="time-choices">
            <input type="radio" class="hidden" value="primary" name="session[time]" id="session_time_primary">
            <label class="time-choice active" for="session_time_primary"><%= @session.primary_time.in_time_zone(current_user.timezone).strftime('%a, %b %d, %Y %l:%M %p') %></label>
            <input type="radio" class="hidden" value="secondary" name="session[time]" id="session_time_secondary">
            <label class="time-choice" for="session_time_secondary"><%= @session.secondary_time.in_time_zone(current_user.timezone).strftime('%a, %b %d, %Y %l:%M %p') %></label>
            <input type="radio" class="hidden" value="tertiary" name="session[time]" id="session_time_tertiary">
            <label class="time-choice" for="session_time_tertiary"><%= @session.tertiary_time.in_time_zone(current_user.timezone).strftime('%a, %b %d, %Y %l:%M %p') %></label>
          </div>
        </div>
        <% if @session.service.service_type == 'Virtual' %>
          <%= f.input :link, input_html: { class: 'w-50' }, label: 'Please add a link for the virtual session' %>
        <% end %>
        <!-- <p>Or choose another time for the session.</p> -->
        <%#= f.input :start_time, as: :string, input_html: {class: "datepicker"} %>
        <div class="session-btns">
          <%= f.submit 'Confirm', class: 'btn btn-flat' %>
          <%= f.submit 'Decline',  data: { confirm: "Are you sure?" }, class: 'btn btn-ghost ml-5' %>
        </div>
      <% end %>
    <% elsif @session.status == 'confirmed' %>
      <p class="mt-3">Your session has been confirmed.</p>
      <div class="session-btns">
        <%= simple_form_for [@session.user, @conversation] do |f| %>
          <%= f.submit 'Send message', class: 'btn btn-flat' %>
        <% end %>
        <% if @session.start_time >= Time.current %>
          <%= simple_form_for [@session] do |f| %>
            <%= f.submit 'Cancel this session',  data: { confirm: "Are you sure?" }, class: 'btn btn-ghost ml-5' %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  <% elsif @session.user == current_user %>
    <div class="d-flex align-items-center">
      <h2><%= link_to @session.service.name, service_path(@session.service) %> with <%= link_to @session.practitioner.user.full_name, practitioner_path(@session.practitioner) %></h2>
      <% if @session.status == 'confirmed' && @session.start_time < Time.current && @session.review == nil %>
        <%= link_to 'Rate', '', data: { toggle: "modal", target: "#newReviewModal" }, class: 'btn btn-flat ml-4' %>
      <% end %>
    </div>
    <% if @session.status == 'pending' && !@session.paid %>
      <p class="mt-3">Thank you for requesting a session with <%= link_to @session.practitioner.user.first_name, practitioner_path(@session.practitioner) %> for <%= link_to @session.service.name, service_path(@session.service) %></p>
      <p><strong>Please complete your checkout to proceed.</strong></p>
      <div class="session-btns">
        <%= link_to 'Go to checkout', new_session_payment_path(@session), class: 'btn btn-flat' %>
        <%= simple_form_for [@session] do |f| %>
          <%= f.submit 'Cancel this request',  data: { confirm: "Are you sure?" }, class: 'btn btn-ghost ml-5' %>
        <% end %>
      </div>
    <% elsif @session.status == 'pending' && @session.paid %>
      <p class="mt-3">Thank you for requesting a session with <%= link_to @session.practitioner.user.first_name, practitioner_path(@session.practitioner) %> for <%= link_to @session.service.name, service_path(@session.service) %></p>
      <p><strong><%= @session.service.practitioner.user.first_name %> will confirm this session shortly.</strong></p>
      <div class="session-btns">
        <%= simple_form_for [@session] do |f| %>
          <%= f.submit 'Cancel this request',  data: { confirm: "Are you sure?" }, class: 'btn btn-ghost' %>
        <% end %>
      </div>
    <% elsif @session.status == 'confirmed' %>
      <p class="mt-3">Thank you for booking a session with <%= link_to @session.practitioner.user.first_name, practitioner_path(@session.practitioner) %> for <%= link_to @session.service.name, service_path(@session.service) %></p>
      <div class="session-btns">
        <%= simple_form_for [@session.practitioner.user, @conversation] do |f| %>
          <%= f.submit 'Send message', class: 'btn btn-flat' %>
        <% end %>
        <% if @session.start_time >= Time.current %>
          <%= simple_form_for [@session] do |f| %>
            <%= f.submit 'Cancel this session',  data: { confirm: "Are you sure?" }, class: 'btn btn-ghost ml-5' %>
          <% end %>
        <% end %>
      </div>
    <% elsif @session.status == 'cancelled' %>
      <h2>This session has been cancelled.</h2>
    <% end %>
  <% end %>
  <% if @session.user == current_user && @session.service.service_type == 'In-person' %>
    <div class="session-detail">
      <div class="session-summary">
        <h3>Session summary</h3>
      <% if @session.start_time %>
        <p>Session time: <span id='session_time'><%= @session.start_time.in_time_zone(current_user.timezone).strftime('%a, %b %d, %Y %l:%M %p') %></span></p>
      <% else %>
        <p>Session time: TBD</p>
      <% end %>
      <p>Duration: <%= @session.service.duration %>m</p>
      <p>Session type: <%= @session.service.service_type.capitalize %></p>
      <% if @session.service.service_type == 'In-person' %>
        <p>Session location: <%= @session.service.practitioner.location %></p>
        <p>Address: <%= @session.service.practitioner.address %></p>
      <% end %>
      <p>Total price: CA$ <%= (@session.service.price * 1.03).round(2) %></p>
      <% if @session.user == current_user %>
        <p>Cancellation Policy: Cancel more than 24 hours before your appointment to get a full refund, less the service fee. Payment cannot be refunded if cancelling within 24 hours of session.</p>
      <% end %>
      </div>
      <div class="session-location">
        <div id="session-map"></div>
      </div>
    </div>
  <% else %>
    <div class="session-detail">
      <div class="session-summary">
        <h3>Your session summary</h3>
        <% if @session.start_time %>
          <p>Session time: <span id='session_time'><%= @session.start_time.in_time_zone(current_user.timezone).strftime('%a, %b %d, %Y %l:%M %p') %></span></p>
        <% else %>
          <p>Session time: TBD</p>
        <% end %>
        <p>Duration: <%= @session.service.duration %>m</p>
        <p>Session type: <%= @session.service.service_type.capitalize %></p>
        <% if @session.service.service_type == 'In-person' %>
          <p>Session location: <%= @session.service.practitioner.location %></p>
          <p>Address: <%= @session.service.practitioner.address %></p>
        <% end %>
        <p>Total price: CA$ <%= (@session.service.price * 1.03).round(2) %></p>
        <p>Virtual Session Link: <%= @session.link %></p>
        <% if @session.user == current_user %>
          <p>Cancellation Policy: Cancel more than 24 hours before your appointment to get a full refund, less the service fee. Payment cannot be refunded if cancelling within 24 hours of session.</p>
        <% end %>
      </div>
      <div class="session-location" style="display: flex; justify-content: flex-end;">
        <%= image_tag('logo-square.jpeg') %>
      </div>
    </div>
  <% end %>
</div>
<% if @session.status == 'confirmed' && @session.start_time < Time.current && @session.review == nil %>
  <div class="modal fade" id="newReviewModal" tabindex="-1" role="dialog" aria-labelledby="newReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
         <h5 class="modal-title" id="newReviewwModalLabel">Write review</h5>
         <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <%= simple_form_for([@session, @review]) do |f| %>
            <%= f.input :rating, collection: [5, 4, 3, 2, 1]  %>
            <%= f.input :comment %>
            <%= f.submit :Submit, class: 'btn btn-flat' %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>
<script>
  const choices = document.querySelectorAll('.time-choice');
  choices.forEach( choice =>
    choice.addEventListener("click", (event) => {
      const active = document.querySelector('.active');
      event.currentTarget.classList.toggle('active');
      if (active !== null) {
        active.classList.remove('active');
      }
    })
  );
</script>

